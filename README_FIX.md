# 数据库日期时间格式修复指南

## 问题描述

数据库中存在ISO格式（如`2025-05-11T19:37:14.519970`）的日期时间字符串，这种格式与SQLite期望的格式不兼容，导致应用程序出现错误：

```
ValueError: Couldn't parse datetime string: '2025-05-11T19:37:14.519970'
```

## 解决方案

我们提供了三个修复脚本，您可以根据情况选择使用：

1. `quick_fix.py` - 简化版修复脚本，直接针对常见表和字段进行修复
2. `fix_datetime.py` - 完整版修复脚本，包含详细日志和全面的表扫描
3. `render_fix_datetime.py` - 专为Render环境设计的修复脚本，具有更好的兼容性

## 在Render上修复方法

请按照以下步骤在Render控制台上执行修复：

1. 登录Render控制台
2. 进入您的Web Service
3. 点击"Shell"选项卡打开命令行界面
4. 执行以下命令：

```bash
# 使用Python3执行修复脚本
python3 render_fix_datetime.py
```

5. 等待脚本完成运行，它会自动：
   - 创建数据库备份
   - 扫描所有表中的日期时间字段
   - 修复格式不兼容的值
   - 输出修复统计信息

6. 脚本执行完成后，重启应用服务：

```bash
# 使用内置命令重启服务
touch /opt/render/etc/restart
```

## 本地修复方法

如果您需要在本地环境修复数据库，请使用以下命令：

```bash
# 执行简化版修复脚本
python quick_fix.py

# 或者执行完整版修复脚本
python fix_datetime.py
```

## 注意事项

1. 脚本会在修复前自动创建数据库备份，备份文件名格式为：
   - `quick_backup_YYYYMMDD_HHMMSS.sqlite`
   - `auto_backup_before_fix_YYYYMMDD_HHMMSS.sqlite`
   - `render_backup_before_fix_YYYYMMDD_HHMMSS.sqlite`

2. 如果修复过程中出现错误，您可以使用备份文件恢复数据库

3. 修复完成后，应用程序需要重启才能正常工作

## 已实施的预防措施

为防止此类问题再次发生，我们已经在代码中实施了以下改进：

1. **添加了安全的日期时间处理方法**：
   - `User.set_last_login()` - 安全设置用户登录时间
   - `ProductPrice.set_date_fields()` - 安全设置价格日期字段
   - `Product.set_date()` - 安全设置产品日期

2. **更新了使用日期时间的关键函数**：
   - 用户登录时使用 `set_last_login()` 安全设置登录时间
   - 更新产品时使用 `set_date()` 安全设置日期
   - 批量操作中使用 `set_date()` 安全设置日期
   - 价格管理中使用 `set_date_fields()` 安全设置价格生效和结束日期

3. **增强了日期时间解析能力**：
   - 自动检测并处理ISO格式的日期时间字符串
   - 在无法解析时提供明确的错误消息和日志
   - 设置合理的默认日期时间值，确保系统稳定性

这些改进确保了即使输入的日期时间格式不完全符合预期，系统也能正确处理，大大降低了类似问题再次发生的风险。

## 后续建议

即使系统现在已经加固，我们仍然建议：

1. 定期备份数据库，特别是在进行导入或批量操作后
2. 监控应用程序日志以及时发现潜在问题
3. 在导入外部数据前先进行格式验证

如有任何问题，请联系系统管理员获取帮助。 